*&---------------------------------------------------------------------*
*& Report Z12_CS9
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
REPORT Z12_CS9.

TABLES: Z12_STUDENT,Z12_TRAIN,SSCRFIELDS,Z12_INSTRUCTOR,Z12_STEN.

DATA: DAT TYPE TABLE OF RKE_DAT,
      D TYPE I,
      THOURS TYPE I.
DATA: IT_FIELDCAT     TYPE  SLIS_T_FIELDCAT_ALV,
      WAFCAT     TYPE SLIS_FIELDCAT_ALV,
      ALV_LAYOUT TYPE SLIS_LAYOUT_ALV.

DATA: TRA TYPE table of  Z12_TRAIN.

DATA: ITAB TYPE TABLE OF ZSTR,
      ITAB2 TYPE TABLE OF ZSTR1,
      WA TYPE ZSTR,
      WA2 TYPE ZSTR1.

  SELECTION-SCREEN BEGIN OF BLOCK B1.
  PARAMETERS: STD RADIOBUTTON GROUP G1,
              INS RADIOBUTTON GROUP G1.
  SELECTION-SCREEN BEGIN OF LINE.
  SELECTION-SCREEN PUSHBUTTON 4(5) TEXT-006 USER-COMMAND NEXT.
  SELECTION-SCREEN PUSHBUTTON 20(5) TEXT-007 USER-COMMAND EXIT.
  SELECTION-SCREEN END OF LINE.
  SELECTION-SCREEN END OF BLOCK B1.

SELECTION-SCREEN BEGIN OF SCREEN 1001.
SELECTION-SCREEN BEGIN OF BLOCK B2 WITH FRAME TITLE TEXT-008.
SELECTION-SCREEN SKIP 2.
PARAMETERS: MANID TYPE Z12_STUDENT-MID,
           MANSAPID TYPE Z12_STUDENT-MSID,
           STUDID TYPE Z12_STUDENT-ST,
           FNAME TYPE Z12_STUDENT-FN,
           LNAME TYPE Z12_STUDENT-LN,
           MNAME TYPE Z12_STUDENT-MN,
           TRAINID TYPE Z12_TRAIN-TID.

SELECTION-SCREEN SKIP 2.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(10) TEXT-001.
SELECTION-SCREEN COMMENT 15(10) TEXT-002 FOR FIELD SDATE.
PARAMETERS SDATE TYPE Z12_TRAIN-STD.
SELECTION-SCREEN COMMENT 38(2) TEXT-004.
SELECTION-SCREEN COMMENT 42(8) TEXT-003 FOR FIELD EDATE.
PARAMETERS EDATE  TYPE Z12_TRAIN-ED.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN SKIP 2.
SELECTION-SCREEN PUSHBUTTON 10(8) TEXT-005 USER-COMMAND SUBMIT.
SELECTION-SCREEN END OF BLOCK B2.
SELECTION-SCREEN END OF SCREEN 1001.




SELECTION-SCREEN BEGIN OF SCREEN 1002.
SELECTION-SCREEN BEGIN OF BLOCK B3 WITH FRAME TITLE TEXT-009.
SELECTION-SCREEN SKIP 2.
PARAMETERS INSID  TYPE Z12_INSTRUCTOR-IN_ID MATCHCODE OBJECT Z12_INST.
SELECTION-SCREEN SKIP.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(10) TEXT-001.
SELECTION-SCREEN COMMENT 15(10) TEXT-002 FOR FIELD SDATE.
PARAMETERS STDATE TYPE Z12_TRAIN-STD.
SELECTION-SCREEN COMMENT 38(2) TEXT-004.
SELECTION-SCREEN COMMENT 42(8) TEXT-003 FOR FIELD EDATE.
PARAMETERS ETDATE  TYPE Z12_TRAIN-ED.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN SKIP 2.
SELECTION-SCREEN PUSHBUTTON 10(8) TEXT-005 USER-COMMAND SUBMIT.
SELECTION-SCREEN END OF BLOCK B3.
SELECTION-SCREEN END OF SCREEN 1002.




AT SELECTION-SCREEN ON BLOCK B1.
IF SSCRFIELDS-UCOMM EQ 'NEXT'  AND STD = 'X'.
  CALL SELECTION-SCREEN '1001'.
  ELSEIF
     SSCRFIELDS-UCOMM EQ 'NEXT'  AND INS = 'X'.
  CALL SELECTION-SCREEN '1002'.
  ELSE.
    LEAVE PROGRAM.
  ENDIF.
AT SELECTION-SCREEN ON VALUE-REQUEST FOR MANID.
  DATA: SEL   TYPE TABLE OF DSELC,
            WASEL TYPE DSELC.


      DATA: ITAB1 TYPE TABLE OF Z12_STUDENT,
            WA1   TYPE Z12_STUDENT.

      SELECT * FROM Z12_STUDENT INTO TABLE  ITAB1.
      REFRESH SEL.
      WASEL-FLDNAME = 'MID'.
      WASEL-DYFLDNAME = 'MANID'.
      APPEND WASEL TO SEL.
       WASEL-FLDNAME = 'MSID'.
      WASEL-DYFLDNAME = 'MANSAPID'.
      APPEND WASEL TO SEL.
       WASEL-FLDNAME = 'FN'.
      WASEL-DYFLDNAME = 'FNAME'.
      APPEND WASEL TO SEL.
      WASEL-FLDNAME = 'LN'.
      WASEL-DYFLDNAME = 'LNAME'.
      APPEND WASEL TO SEL.
      WASEL-FLDNAME = 'MN'.
      WASEL-DYFLDNAME = 'MNAME'.
      APPEND WASEL TO SEL.
       WASEL-FLDNAME = 'ST'.
      WASEL-DYFLDNAME = 'STUDID'.
      APPEND WASEL TO SEL.

        CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
        EXPORTING
          DDIC_STRUCTURE  = 'Z12_STUDENT'
          RETFIELD        = 'MID'
*         PVALKEY         = ' '
          DYNPPROG        = SY-REPID
          DYNPNR          = SY-DYNNR
          DYNPROFIELD     = 'Z12_STUDENT-MID'
          VALUE_ORG       = 'S'
        TABLES
          VALUE_TAB       = ITAB1
          DYNPFLD_MAPPING = SEL.

*
AT SELECTION-SCREEN ON BLOCK B2.
  CASE SSCRFIELDS-UCOMM.
  WHEN 'SUBMIT'.
  SELECT
  A~ST,
  A~FN,
  B~TID,
  C~MARKS
  FROM Z12_STUDENT AS A INNER JOIN Z12_STEN  AS C ON A~ST = C~STID
  INNER JOIN Z12_TRAIN AS B ON B~TID = C~TID
  WHERE A~MID = @MANID AND A~MSID = @MANSAPID
  INTO CORRESPONDING FIELDS OF TABLE @ITAB.


   SELECT TID,STD, ED FROM Z12_TRAIN INTO  CORRESPONDING FIELDS OF table @TRA
   FOR ALL ENTRIES IN @ITAB
   WHERE TID = @ITAB-TID.
   LOOP AT TRA INTO DATA(WTRA).
   CALL FUNCTION 'RKE_SELECT_FACTDAYS_FOR_PERIOD'
       EXPORTING
         I_DATAB                     = WTRA-STD
         I_DATBI                     = WTRA-ED
         I_FACTID                    = 'IN'
        TABLES
         ETH_DATS                    =  DAT.
   DESCRIBE TABLE DAT LINES D.
   THOURS = D *  8.
   IF SDATE BETWEEN WTRA-STD AND WTRA-ED.
   WA-STATUS = 'TRAINING ON'.
   ELSE.
   WA-STATUS = 'TRAINING DONE'.
   ENDIF.
WA-THOURS = THOURS.
MODIFY  ITAB FROM WA TRANSPORTING THOURS STATUS WHERE TID = WTRA-TID.
ENDLOOP.
 CALL FUNCTION 'REUSE_ALV_FIELDCATALOG_MERGE'
 EXPORTING
 I_STRUCTURE_NAME             = 'ZSTR'
 CHANGING
 CT_FIELDCAT                  = IT_FIELDCAT.

 CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
 EXPORTING
 IT_FIELDCAT                       = IT_FIELDCAT
 TABLES
 T_OUTTAB                          = ITAB.

ENDCASE.

AT SELECTION-SCREEN ON BLOCK B3.
  CASE SSCRFIELDS-UCOMM.
  WHEN 'SUBMIT'.
  SELECT
  B~TID,
  A~PC,
  A~SC
  FROM Z12_INSTRUCTOR AS A INNER JOIN Z12_IA AS B ON A~IN_ID = B~INID
  INNER JOIN Z12_AT AS C ON B~TID = C~TID
  WHERE A~IN_ID = @INSID
  INTO CORRESPONDING FIELDS OF TABLE @ITAB2.

   SELECT TID, STD, ED FROM Z12_TRAIN INTO  CORRESPONDING FIELDS OF table @TRA
   FOR ALL ENTRIES IN @ITAB2
   WHERE TID = @ITAB2-TID.
   LOOP AT TRA INTO DATA(WTRA).
   CALL FUNCTION 'RKE_SELECT_FACTDAYS_FOR_PERIOD'
       EXPORTING
         I_DATAB                     = wTRA-STD
         I_DATBI                     = wTRA-ED
         I_FACTID                    = 'IN'
        TABLES
         ETH_DATS                    =  DAT.
   DESCRIBE TABLE DAT LINES D.
   THOURS = D *  8.
   IF SDATE BETWEEN WTRA-STD AND WTRA-ED.
   WA-STATUS = 'TRAINING ON'.
   ELSE.
   WA-STATUS = 'TRAINING DONE'.
   ENDIF.
WA2-THOURS = THOURS.
MODIFY  ITAB2 FROM WA2 TRANSPORTING THOURS WHERE TID = WTRA-TID.
ENDLOOP.
 CALL FUNCTION 'REUSE_ALV_FIELDCATALOG_MERGE'
 EXPORTING
 I_STRUCTURE_NAME             = 'ZSTR1'
 CHANGING
 CT_FIELDCAT                  = IT_FIELDCAT.

 CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
 EXPORTING
 IT_FIELDCAT                       = IT_FIELDCAT
 TABLES
 T_OUTTAB                          = ITAB2.

    ENDCASE.
